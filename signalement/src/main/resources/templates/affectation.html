<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="template"     
      lang="en">
  <head>
      <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ==" crossorigin="" />
        <style type="text/css">
            #map{ /* la carte DOIT avoir une hauteur sinon elle n'apparaît pas */
                height:500px;
            }
        </style>
    <title>Affectation</title>
    <meta charset="utf-8">
  </head>
  <body class="app sidebar-mini rtl">
    <div layout:fragment="content1">
        <main class="app-content">
            <div class="row justify-content-center">
                <div class="col-md-10">
                     <div id="map">
                        <!-- Ici s'affichera la carte -->
                    </div>
                </div>
                    <div class="col-md-10">
                    <div class="tile">
                      <h3 class="tile-title">Table Hover</h3>
                      <table class="table table-hover">
                        <thead>
                          <tr>
                            <th>Titre</th>
                            <th>Type</th>
                            <th>Longitude</th>
                            <th>Latitude</th>
                            <th>Region</th>
                            <th></th>
                            <th></th>
                            <th th:text="${testa}"></th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr class="clicktr" th:each="s:${signalement}">
                            <td th:text="${s.getSignalnew().getTitre()}"></td>
                            <td th:text="${s.getType().getNom()}"></td>
                            <td class="lat" th:text="${s.getLatitude()}"></td>
                            <td class="long" th:text="${s.getLongitude()}"></td>
                            <form method="get" action="#">
                                 <td>
                                <select  id="inputState" class="form-control">
                                    <th:block th:each="r:${region}">
                                        <option th:text="${r.getNom()}"></option>
                                    </th:block>
                                </select>
                            </td>
                            <td><input type="submit" class="btn-primary" value="Affecter"></td>
                            </form>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
        </main>
        <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js" integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw==" crossorigin=""></script>
        <script th:inline="javascript">
          var size = [[${signalement.size()}]];
          alert(size);
          var dataLayer = new Array(0);
          </script>
        <script th:each="s:${signalement}" th:inline="javascript">
            var tempy = new Array([[${s.getLatitude()}]],[[${s.getLongitude()}]]);
            dataLayer.push(tempy);
        </script>
	<script th:inline="javascript">
            // On initialise la latitude et la longitude de Paris (centre de la carte)
            var lat = 48.852969;
            var lon = 2.349903;
            var macarte = null;
            // Fonction d'initialisation de la carte
            function initMap() {
                // Créer l'objet "macarte" et l'insèrer dans l'élément HTML qui a l'ID "map"
                macarte = L.map('map').setView([lat, lon], 11);
                // Leaflet ne récupère pas les cartes (tiles) sur un serveur par défaut. Nous devons lui préciser où nous souhaitons les récupérer. Ici, openstreetmap.fr
                L.tileLayer('https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png', {
                    // Il est toujours bien de laisser le lien vers la source des données
                    attribution: 'données © <a href="//osm.org/copyright">OpenStreetMap</a>/ODbL - rendu <a href="//openstreetmap.fr">OSM France</a>',
                    minZoom: 1,
                    maxZoom: 20
                }).addTo(macarte);
                    alert(dataLayer.length);
                    for(var i=0;i<dataLayer.length;i++)
                    {
                        var marker = L.marker([dataLayer[i][0],dataLayer[i][1]]).addTo(macarte);
                    }
                  
            }
            function clicktr(){
                let tr=$(".clicktr");
                tr.click(function(){
                // Holds the product ID of the clicked element
                let latnew=tr.find(".lat").text();
                let lonnew=tr.find(".long").text();
                macarte.setView([latnew, lonnew], 11);
              });
            }
            window.onload = function(){
		// Fonction d'initialisation qui s'exécute lorsque le DOM est chargé
		initMap();
                clicktr();
            };
        </script>
          
    </div>
    
  </body>
</html>